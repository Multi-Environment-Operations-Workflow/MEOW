@page "/test-page"
@using System.Collections.Specialized
@using MEOW_BUSINESS.Models
@using MEOW_BUSINESS.Services
@inject IChatService ChatService
@inject NavigationManager Navigation
@using System.Timers
@inject IErrorService ErrorService
@inject IUserStateService UserStateService
@using System.Text
@using System.IO

<div class="text-center mt-4">
    <button class="btn btn-warning btn-lg rounded-pill fw-semibold" @onclick="SaveCsvAsync">
        üíæ Gem CSV i Downloads
    </button>
</div>



<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-4">
                    <h3 class="text-center mb-4 text-primary fw-bold">üì® Test ‚Äì Send beskeder</h3>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">V√¶lg foruddefineret besked</label>
                        <select class="form-select" @bind="SelectedPresetMessage">
                            @foreach (var msg in PresetMessages)
                            {
                                <option value="@msg">@msg</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Antal beskeder</label>
                        <select class="form-select" @bind="MessageCount">
                            @foreach (var n in new[] { 1, 5, 10, 20, 50, 100, 1000, 10000 })
                            {
                                <option value="@n">@n</option>
                            }
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Over hvor lang tid (sekunder)</label>
                        <select class="form-select" @bind="DurationSeconds">
                            @foreach (var s in new[] { 1, 5, 10, 30, 60 })
                            {
                                <option value="@s">@s sekunder</option>
                            }
                        </select>
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg rounded-pill fw-semibold" @onclick="StartSending" disabled="@IsRunning">
                            @if (IsRunning)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Afsender...</span>
                            }
                            else
                            {
                                <span>üöÄ Start afsendelse</span>
                            }
                        </button>
                    </div>

                    @if (IsRunning)
                    {
                        <div class="alert alert-info mt-4 text-center mb-0">
                            Afsendelse er i gang...
                        </div>
                    }

                    @if (ElapsedSeconds is not null)
                    {
                        <div class="alert alert-success mt-4 text-center mb-0">
                            ‚úÖ F√¶rdig! Varighed: <strong>@ElapsedSeconds?.ToString("0.00") sekunder</strong>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(StatusMessage))
                    {
                        <div class="alert alert-secondary mt-3 text-center">@StatusMessage</div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- MODTAG PANEL -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-8">
            <div class="card shadow border-0 rounded-4">
                <div class="card-body p-4">
                    <h4 class="text-center text-success fw-bold mb-4">üì• Modtagelse af beskeder</h4>

                    @if (!IsReceiving)
                    {
                        <div class="text-center mb-3">
                            <button class="btn btn-success btn-lg rounded-pill fw-semibold" @onclick="StartReceiving">
                                ‚ñ∂Ô∏è Start modtagelse
                            </button>
                        </div>
                    }

                    @if (IsReceiving)
                    {
                        <div class="alert alert-info text-center">Modtager beskeder...</div>
                    }

                    @if (ReceiveCount > 0)
                    {
                        <div class="mt-3">
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>üì¶ Modtaget:</strong></span>
                                    <span>@ReceiveCount beskeder</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>‚è∞ Starttidspunkt:</strong></span>
                                    <span>@ReceiveStartTime?.ToString("HH:mm:ss.fff")</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>‚ö° Hastighed:</strong></span>
                                    <span>@(ReceiveDuration > 0 ? (ReceiveCount / ReceiveDuration).ToString("0.00") : "0") beskeder/sek.</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>üïí Samlet varighed:</strong></span>
                                    <span>@ReceiveDuration.ToString("0.00") sek.</span>
                                </li>
                            </ul>
                        </div>
                    }

                    @if (ReceiveCompleted)
                    {
                        <div class="alert alert-success mt-4 text-center mb-0">
                            ‚úÖ Modtagelse afsluttet efter <strong>@ReceiveDuration.ToString("0.00") sekunder</strong>
                            ‚Äì @ReceiveCount beskeder modtaget.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- FEJL PANEL -->
    @if (ErrorDetails.Any())
    {
        <div class="mt-5 p-4 border rounded bg-light">
            <h5 class="fw-bold text-danger mb-3">üö® Fejldetaljer</h5>
            @foreach (var e in ErrorDetails)
            {
                <div class="mb-4">
                    <div><strong>Besked:</strong> @e.MessageNumber / @MessageCount</div>
                    <div><strong>Indhold:</strong> @e.MessageText</div>
                    <div><strong>Type:</strong> @e.ExceptionType</div>
                    <div><strong>Fejl:</strong> @e.Message</div>
                    <pre class="bg-white border p-2 mt-2 rounded" style="font-size:0.8em; white-space:pre-wrap;">@e.StackTrace</pre>
                </div>
            }
        </div>
    }
</div>

@code {

    private string SelectedPresetMessage { get; set; } = "Hej";
    private int ReceiveTimeoutSeconds { get; set; } = 5;

    private int MessageCount { get; set; } = 1;
    private int DurationSeconds { get; set; } = 1;

    private bool IsRunning { get; set; }
    private double? ElapsedSeconds { get; set; }
    private string StatusMessage { get; set; } = "";

    private List<string> PresetMessages = new() { "Hej", "Test", "Status OK", "Fejl fundet" };
    private List<ErrorInfo> ErrorDetails { get; set; } = new();

    private bool IsReceiving { get; set; }
    private bool ReceiveCompleted { get; set; }
    private int ReceiveCount { get; set; }
    private DateTime? ReceiveStartTime { get; set; }
    private DateTime? ReceiveEndTime { get; set; }
    private double ReceiveDuration => (ReceiveEndTime.HasValue && ReceiveStartTime.HasValue)
        ? (ReceiveEndTime.Value - ReceiveStartTime.Value).TotalSeconds
        : 0;

    private System.Timers.Timer? _timeoutTimer;

private async Task SaveCsvAsync()
{
#if ANDROID
    try
    {
        var log = MessageService.Chatlog.message_log;

        var sb = new StringBuilder();
        sb.AppendLine("Name,Message,Timestamp");

        foreach (var entry in log)
        {
            sb.AppendLine(
                $"\"{entry.Name}\",\"{entry.Content}\",\"{entry.Time:HH:mm:ss.fff}\""
            );
        }

        var bytes = Encoding.UTF8.GetBytes(sb.ToString());
        var fileName = $"chatlog_{DateTime.Now:yyyyMMdd_HHmmss}.csv";

        var context = Android.App.Application.Context;

        var values = new Android.Content.ContentValues();
        values.Put(Android.Provider.MediaStore.IMediaColumns.DisplayName, fileName);
        values.Put(Android.Provider.MediaStore.IMediaColumns.MimeType, "text/csv");
        values.Put(Android.Provider.MediaStore.Files.FileColumns.RelativePath, "Download/");
        values.Put(Android.Provider.MediaStore.IMediaColumns.IsPending, true);

        var uri = context.ContentResolver.Insert(
            Android.Provider.MediaStore.Downloads.ExternalContentUri,
            values
        );

        if (uri == null)
            throw new Exception("Kunne ikke oprette fil i MediaStore!");

        using (var stream = context.ContentResolver.OpenOutputStream(uri, "w"))
        {
            stream.Write(bytes, 0, bytes.Length);
        }

        values = new Android.Content.ContentValues();
        values.Put(Android.Provider.MediaStore.IMediaColumns.IsPending, false);
        context.ContentResolver.Update(uri, values, null, null);

        StatusMessage = $"‚úîÔ∏è Fil gemt i Downloads: {fileName}";
    }
    catch (Exception ex)
    {
        StatusMessage = "‚ùå Fejl: " + ex.Message;
    }
#else
    StatusMessage = "Ikke underst√∏ttet p√• denne platform.";
#endif

    StateHasChanged();
}



    private void StartReceiving()
    {
        if (IsReceiving) return;

        IsReceiving = true;
        ReceiveCompleted = false;
        ReceiveCount = 0;
        ReceiveStartTime = null;
        ReceiveEndTime = null;

        var messages = ChatService.GetChatMessages();
        foreach (var msg in messages)
        {
            HandleIncomingMessage(msg);
        }

        // Subscribe using correct event handler type
        ChatService.SetupChatMessageReceivedAction(OnCollectionChanged);

        StateHasChanged();
    }

    // The correct signature for NotifyCollectionChangedEventHandler
    private void OnCollectionChanged(object? sender, NotifyCollectionChangedEventArgs e)
    {
        if (e.NewItems != null)
        {
            foreach (var item in e.NewItems)
            {
                if (item is MeowMessageText msg)
                {
                    HandleIncomingMessage(msg);
                }
            }
        }
    }

    // Your existing message handling logic, unchanged
    private void HandleIncomingMessage(MeowMessageText msg)
    {

        if (ReceiveStartTime is null)
            ReceiveStartTime = DateTime.Now;

        ReceiveCount++;
        ReceiveEndTime = DateTime.Now;

        _timeoutTimer?.Stop();
        _timeoutTimer ??= new System.Timers.Timer(ReceiveTimeoutSeconds * 1000);
        _timeoutTimer.Elapsed -= new System.Timers.ElapsedEventHandler(TimeoutElapsed);
        _timeoutTimer.Elapsed += new System.Timers.ElapsedEventHandler(TimeoutElapsed);
        _timeoutTimer.AutoReset = false;
        _timeoutTimer.Start();

        try
        {
            InvokeAsync(StateHasChanged);
        }
        catch (NotImplementedException)
        {
            Console.WriteLine("NotImplementedException ignoreret ‚Äì AndroidNotificationManagerService ikke aktiv.");
        }
    }

    private void TimeoutElapsed(object? sender, ElapsedEventArgs e) => StopReceiving();

    private void StopReceiving()
    {
        if (!IsReceiving) return;

        _timeoutTimer?.Stop();
        _timeoutTimer?.Dispose();
        _timeoutTimer = null;

        IsReceiving = false;
        ReceiveCompleted = true;
        ReceiveEndTime ??= DateTime.Now;
        InvokeAsync(StateHasChanged);
    }

    // --- Sending logic unchanged ---
    private async Task StartSending()
    {
        if (IsRunning) return;
        if (string.IsNullOrWhiteSpace(SelectedPresetMessage))
        {
            StatusMessage = "‚ö†Ô∏è V√¶lg en besked f√∏rst.";
            return;
        }

        IsRunning = true;
        ElapsedSeconds = null;
        ErrorDetails.Clear();
        StatusMessage = "Starter afsendelse...";
        StateHasChanged();

        try
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();
            double totalMs = DurationSeconds * 1000.0;
            double intervalMs = MessageCount > 1 ? totalMs / (MessageCount - 1) : 0;

            for (int i = 0; i < MessageCount; i++)
            {
                var msg = $"{SelectedPresetMessage} #{i + 1}";

                var plannedTime = i * intervalMs;

                try
                {
                    var result = await ChatService.SendMessage(msg);
                    if (!result.Item1)
                    {
                        var exceptions = result.Item2?.Any() == true
                            ? result.Item2.SelectMany(UnwrapExceptions)
                            : new[] { new Exception("Ukendt fejl ‚Äî SendMessage returnerede false uden exceptions") };

                        foreach (var ex in exceptions)
                        {
                            ErrorDetails.Add(new ErrorInfo
                            {
                                MessageNumber = i + 1,
                                MessageText = msg,
                                ExceptionType = ex.GetType().FullName ?? "Ukendt",
                                Message = ex.Message,
                                StackTrace = ex.ToString()
                            });
                        }

                        ErrorService.Add(exceptions.ToList());
                        StatusMessage = $"‚ùå Fejl ved besked {i + 1} (se detaljer nedenfor)";
                        StateHasChanged();
                        break;
                    }

                    StatusMessage = $"‚úÖ Sendt {i + 1}/{MessageCount}";
                }
                catch (Exception sendEx)
                {
                    foreach (var ex in UnwrapExceptions(sendEx))
                    {
                        ErrorDetails.Add(new ErrorInfo
                        {
                            MessageNumber = i + 1,
                            MessageText = msg,
                            ExceptionType = ex.GetType().FullName ?? "Ukendt",
                            Message = ex.Message,
                            StackTrace = ex.ToString()
                        });
                    }

                    ErrorService.Add(sendEx);
                    StatusMessage = $"üí• Fejl ved besked {i + 1}: {sendEx.Message}";
                    StateHasChanged();
                    break;
                }

                var elapsed = stopwatch.Elapsed.TotalMilliseconds;
                var waitMs = plannedTime + intervalMs - elapsed;
                if (waitMs > 0)
                    await Task.Delay((int)waitMs);

                StateHasChanged();
            }

            stopwatch.Stop();
            ElapsedSeconds = stopwatch.Elapsed.TotalSeconds;
            StatusMessage = $"‚úÖ Afsendelse f√¶rdig ({ElapsedSeconds:0.00}s)";
        }
        catch (Exception ex)
        {
            if (ex is NotImplementedException)
            {
                StatusMessage = "‚ö†Ô∏è Notifikationer er ikke implementeret (ignoreres i test).";
                StateHasChanged();
                return;
            }

            foreach (var inner in UnwrapExceptions(ex))
            {
                ErrorDetails.Add(new ErrorInfo
                {
                    MessageNumber = 0,
                    MessageText = "(ukendt)",
                    ExceptionType = inner.GetType().FullName ?? "Ukendt",
                    Message = inner.Message,
                    StackTrace = inner.ToString()
                });
            }

            ErrorService.Add(ex);
            StatusMessage = "üí• Generel fejl under afsendelse (se detaljer nedenfor)";
            StateHasChanged();
        }
        finally
        {
            IsRunning = false;
            StateHasChanged();
        }
    }

    private static IEnumerable<Exception> UnwrapExceptions(Exception ex)
    {
        if (ex is AggregateException agg)
            return agg.InnerExceptions.SelectMany(UnwrapExceptions);
        if (ex.InnerException is not null)
            return new[] { ex }.Concat(UnwrapExceptions(ex.InnerException));
        return new[] { ex };
    }

    private class ErrorInfo
    {
        public int MessageNumber { get; set; }
        public string MessageText { get; set; } = "";
        public string ExceptionType { get; set; } = "";
        public string Message { get; set; } = "";
        public string StackTrace { get; set; } = "";
    }
}
