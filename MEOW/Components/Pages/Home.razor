@page "/"
@using System.Collections.ObjectModel
@using MEOW.Components.Enums
@using MEOW.Components.Models
@using MEOW.Components.Services
@inject IBluetoothService Bluetooth
@inject IUserStateService UserStateService
@inject NavigationManager Navigation
@inject INotificationManagerService NotificationManagerService
@inject IErrorService ErrorService

<h1>Bluetooth Devices</h1>
<p>Welcome, @_name!</p>

@if (!string.IsNullOrEmpty(_advertisingMessage))
{
    <p class="advertising-status">@_advertisingMessage</p>
}

<div class="button-bar">
    <MatButton class="action-button" @onclick="ScanAsync">🔍 Scan for Devices</MatButton>
    <MatButton class="advertise-button" @onclick="StartAdvertisingAsync">📡 Start Advertising</MatButton>
    <MatButton class="stop-button" @onclick="StopAdvertisingAsync">🛑 Stop Advertising</MatButton>
    <MatButton class="sync-automatically" @onclick="RunAsyncScan">🔍 Scan and Connect Devices</MatButton>
    <MatButton class="sync-automatically" @onclick="Bluetooth.StopConnection">🔍 Disconnect Devices</MatButton>
</div>

@if (_isScanning)
{
    <p>Scanning...</p>
}

@if (!_devices.Any() && !_isScanning)
{
    <p>No devices found.</p>
}
else
{
    <ul class="device-list">
        @foreach (var d in _devices)
        {
            <li>
                <MatButton class="device-button" @onclick="() => ConnectAsync(d)">
                    @GetDeviceDisplay(d)
                </MatButton>
            </li>
        }
    </ul>
}

@code {
    private string _name = string.Empty;
    private bool _isScanning;
    private ObservableCollection<MeowDevice> _devices = new();
    private string _advertisingMessage = string.Empty;

    protected override void OnInitialized()
    {
        if (String.IsNullOrEmpty(UserStateService.GetName()))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        _name = UserStateService.GetName();

        _devices = Bluetooth.Devices;
        Bluetooth.AdvertisingStateChanged += OnAdvertisingStateChanged;
        Bluetooth.PeerConnected += OnPeerConnected;
    }

    private void OnPeerConnected()
    {
        // both central and peripheral will hit this and navigate to chat
        Navigation.NavigateTo("/Chat");
    }

    private void OnAdvertisingStateChanged(AdvertisingState state, string? message)
    {
        _advertisingMessage = message ?? string.Empty;
        InvokeAsync(StateHasChanged);
    }

    private async Task ScanAsync()
    {
        if (_isScanning) return;
        _isScanning = true;
        try
        {
            await Bluetooth.ScanAsync();
        }
        catch (Exception e)
        {
            ErrorService.Add(e);
        }

        _isScanning = false;
    }

    private async Task ConnectAsync(MeowDevice device)
    {
        try
        {
            await Bluetooth.ConnectAsync(device);
            Navigation.NavigateTo("/Chat");
        }
        catch (Exception e)
        {
            ErrorService.Add(e);
        }
    }

    private async Task StartAdvertisingAsync()
    {
        try
        {
            await Bluetooth.StartAdvertisingAsync("(MEOW) " + UserStateService.GetName());
        }
        catch (Exception ex)
        {
            ErrorService.Add(ex);
        }
    }

    private async Task StopAdvertisingAsync()
    {
        await Bluetooth.StopAdvertisingAsync();
    }

    private string GetDeviceDisplay(MeowDevice device)
    {
        return $"{device.Name} ({device.Id})";
    }

    private async Task RunAsyncScan()
    {
        try
        {
            await Bluetooth.KeepScanning(TimeSpan.FromSeconds(10));
        }
        catch (OperationCanceledException e)
        {
            ErrorService.Add(e);
        }
    }
}
