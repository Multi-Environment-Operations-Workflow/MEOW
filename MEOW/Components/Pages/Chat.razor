@page "/Chat"
@using MEOW.Components.Models;
@inject Services.IMessageService MessageService
@inject NavigationManager Navigation

<h3>Chat</h3>

<div class="chat-window">
    <span>Connected devices: @MessageService.GetParticipantsCount()</span>
    <div class="messages">
        @*
        @foreach (var m in _messages)
        {
            <div>@m</div>
        }
        *@
        @foreach (var m in _messages)
        {
            <div><strong>@m.Sender:</strong> @m.Message</div>
        }
    </div>

    <input @bind="_outgoing" placeholder="Type a message..." />
    <button @onclick="SendAsync">Send</button>
    <button @onclick="GoBack">Back</button>
</div>

@code {
    private string _outgoing = string.Empty;
    private List<MeowMessageText> _messages = new();
    private Action<MeowMessageText>? _messageReceived;

    protected override Task OnInitializedAsync()
    {
        _messages = MessageService.GetMessages<MeowMessageText>();

        try
        {
            /*
            _messageReceived = message =>
            {
            _messages.Add($"{message}");
            InvokeAsync(StateHasChanged);
            };
            */

            _messageReceived = message =>
            {
                _messages.Add(message);
                InvokeAsync(StateHasChanged);
            };

            //MessageService.SetupMessageReceivedAction(_messageReceived);
            MessageService.SetupMessageReceivedAction<MeowMessageText>(_messageReceived);

            return Task.CompletedTask;
        }
        catch (Exception e)
        {
            _messages.Add(new MeowMessageText(e.Message, "error"));
            return Task.CompletedTask;
        }
    }
    private async Task SendAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_outgoing))
                return;

            //var result = await MessageService.SendMessage(_outgoing);
            var test = await MessageService.SendMessage(_outgoing);
            //_messages.Add(result.Item1 ? $"You: {_outgoing}" : $"<Failed to send>: {_outgoing}");
            _messages.Add(new MeowMessageText(_outgoing, "You"));
            //foreach (var exception in result.Item2)
            //{
            // _messages.Add($"Error in send: " + exception.Message);
            //}

            _outgoing = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            _messages.Add(new MeowMessageText(e.Message, "error"));
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}
