@page "/Chat"
@using System.Collections.Specialized
@using MEOW.Components.Models
@using MEOW.Components.Services
@inject IChatService ChatService
@inject NavigationManager Navigation
@inject IErrorService ErrorService

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* full viewport height */
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        overflow: hidden; /* prevent outer scroll */
    }

    /* Header */
    .chat-header {
        background: white;
        padding: 20px 24px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
        flex-shrink: 0; /* don’t shrink header */
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .back-btn {
        background: transparent;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.2s;
        color: #667eea;
    }

    .back-btn:hover {
        background: #f7fafc;
    }

    .chat-title {
        font-size: 24px;
        font-weight: 600;
        color: #2d3748;
        margin: 0;
    }

    .participants-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .online-dot {
        width: 8px;
        height: 8px;
        background: #48bb78;
        border-radius: 50%;
        display: inline-block;
    }

    /* Participants dropdown */
    .participants-list {
        position: relative;
        cursor: pointer;
    }

    .participants-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        padding: 12px 0;
        min-width: 200px;
        display: none;
    }

    .participants-list:hover .participants-dropdown {
        display: block;
    }

    .participant-item {
        padding: 10px 20px;
        color: #2d3748;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .participant-item:hover {
        background: #f7fafc;
    }

    /* Messages area */
    .messages-container {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        scroll-behavior: smooth;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 16px;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease;
    }
    
    .message-received {
        align-self: flex-start;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .message-error {
        align-self: center;
        background: #fed7d7;
        color: #c53030;
        font-size: 13px;
    }

    .message-sender {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 4px;
        opacity: 0.8;
    }

    .message-text {
        font-size: 15px;
        line-height: 1.4;
    }

    /* Input area */
    .input-container {
        background: white;
        padding: 20px 24px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex-shrink: 0; /* prevent from resizing */
    }

    .message-input {
        flex: 1;
    }

    .send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 15px;
    }

    .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .send-btn:active {
        transform: translateY(0);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Scrollbar styling */
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
</style>


<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-left">
            <button class="back-btn" @onclick="GoBack">←</button>
            <h3 class="chat-title">Chat</h3>
        </div>
        <div class="participants-list">
            <div class="participants-badge">
                <span class="online-dot"></span>
                @ChatService.GetChatParticipantsCount() online
            </div>
            <div class="participants-dropdown">
                @foreach (var name in ChatService.GetConnectedDeviceName())
                {
                    <div class="participant-item">
                        <span class="online-dot"></span>
                        @name
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-container">
        @foreach (var m in _messages)
        {
            @if (m.Sender.ToLower() == "error")
            {
                <div class="message-bubble message-error">
                    <div class="message-text">⚠️ @m.Message</div>
                </div>
            }
            else if (m.Sender == "You")
            {
                <div class="message-bubble message-sent">
                    <div class="message-text">@m.Message</div>
                </div>
            }
            else
            {
                <div class="message-bubble message-received">
                    <div class="message-sender">@m.Sender</div>
                    <div class="message-text">@m.Message</div>
                </div>
            }
        }
    </div>

    <div class="input-container">
        <MatTextField @bind-Value="_outgoing" 
                      Label="Type a message..." 
                      Class="message-input"
                      Immediate="true" />
        <button class="send-btn" @onclick="SendAsync" disabled="@string.IsNullOrWhiteSpace(_outgoing)">
            Send
        </button>
    </div>
</div>

@code {
    private string _outgoing = string.Empty;
    private List<MeowMessageText> _messages = new();

    protected override Task OnInitializedAsync()
    {
        try
        {
            _messages = ChatService.GetChatMessages();
            ChatService.SetupChatMessageReceivedAction(OnNewMessage);
            return base.OnInitializedAsync();
        }
        catch (Exception e)
        {
            _messages.Add(new MeowMessageText("Error initializing chat: " + e.Message, "error"));
            return base.OnInitializedAsync();
        }
    }

    private void OnNewMessage(object? _, NotifyCollectionChangedEventArgs e)
    {
        if (e.Action != NotifyCollectionChangedAction.Add || e.NewItems == null) return;
        _messages.AddRange(e.NewItems.Cast<MeowMessageText>());
        InvokeAsync(StateHasChanged);
    }

    private async Task SendAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_outgoing))
                return;

            var result = await ChatService.SendMessage(_outgoing);
            _messages.Add(new MeowMessageText(_outgoing, "You"));

            if (!result.Item1)
            {
                var exceptions = !result.Item2.Any()
                    ? [new Exception("unknown error")]
                    : result.Item2;

                ErrorService.Add(exceptions);
            }

            _outgoing = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            _messages.Add(new MeowMessageText(e.Message, "error"));
            await InvokeAsync(StateHasChanged);
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}