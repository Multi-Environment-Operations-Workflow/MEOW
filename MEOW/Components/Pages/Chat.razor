@page "/Chat"
@using MEOW_BUSINESS.Models
@using MEOW_BUSINESS.Services
@inject IMessageService MessageService
@inject NavigationManager Navigation

<h3>Chat</h3>

<div class="chat-window">
    <span>Connected devices: @MessageService.GetParticipantsCount()</span>
    <div class="messages">
        @foreach (var m in _messages)
        {
            <div><strong>@m.Sender:</strong> @m.Message</div>
        }
    </div>

    <MatTextField @bind-Value="_outgoing" Label="Send a message" />
    <MatButton @onclick="SendAsync">Send</MatButton>
    <MatButton @onclick="GoBack">Back</MatButton>
</div>

@code {
    private string _outgoing = string.Empty;
    private List<MeowMessageText> _messages = new();
    private Action<MeowMessageText>? _messageReceived;

    protected override Task OnInitializedAsync()
    {
        _messages = MessageService.GetMessages<MeowMessageText>();

        try
        {
            _messageReceived = message =>
            {
                _messages.Add(message);
                InvokeAsync(StateHasChanged);
            };

            MessageService.SetupMessageReceivedAction<MeowMessageText>(_messageReceived);

            return Task.CompletedTask;
        }
        catch (Exception e)
        {
            _messages.Add(new MeowMessageText(e.Message, "error"));
            return Task.CompletedTask;
        }
    }

    private async Task SendAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_outgoing))
                return;

            MeowMessageText message = new(_outgoing, MessageService.GetSender());

            var result = await MessageService.SendMessage(message);
            _messages.Add(new MeowMessageText(_outgoing, "You"));

            _outgoing = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            _messages.Add(new MeowMessageText(e.Message, "error"));
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

}
