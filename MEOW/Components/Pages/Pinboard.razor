@page "/Pinboard"
@using System.Diagnostics
@using MEOW.Components.DTO_s
@using MEOW.Components.Models
@inject Services.IPinService PinService

<div class="pinboard-container">
    <div class="pinboard-header">
        <h2 class="pinboard-title">Pinboard</h2>

        <MatButton Raised="true" Icon="@(_isPinFormVisible ? "expand_less" : "add_circle_outline")" 
                   OnClick="TogglePinVisibility"
                   Class="add-pin-btn">
            @(_isPinFormVisible ? "Hide Pin Module" : "Add Pin")
        </MatButton>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-banner">
            <MatIcon>error</MatIcon>
            <span>@_errorMessage</span>
        </div>
    }

    @if (_isPinFormVisible)
    {
        <MatCard Class="pin-form-card animate-fadeIn">
            <EditForm Model="@_currentPin" OnValidSubmit="AddPin">
                <DataAnnotationsValidator />

                <MatTextField Label="Title" @bind-Value="_currentPin.Title" Required="true" FullWidth="true" />
                <ValidationMessage For="@(() => _currentPin.Title)" />

                <MatTextField Label="Context" @bind-Value="_currentPin.TextContext"
                              TextArea="true" Rows="5" FullWidth="true" Class="mt-3" />
                <ValidationMessage For="@(() => _currentPin.TextContext)" />

                <MatDivider Class="my-4" />

                <MatFileUpload OnChange="@FilesReady"
                               Label="Drop an image or browse"
                               Icon="cloud_upload"
                               Accept="image/*" />

                @if (_currentPin.FileData != null)
                {
                    <div class="preview-image">
                        <img src="data:image/png;base64,@_currentPin.FileData" />
                    </div>
                }

                <MatDivider Class="my-4" />

                <MatButton Raised="true" Icon="add_task" Type="submit" Color="MatThemeColor.Primary">
                    Create Pin
                </MatButton>
            </EditForm>
        </MatCard>
    }

    <div class="pins-list">
        @if (!_pinList.Any())
        {
            <div class="empty-state animate-fadeIn">
                <MatIcon>info</MatIcon>
                <p>No pins yet â€” add one above!</p>
            </div>
        }
        else
        {
            @foreach (var pin in _pinList)
            {
                <MatCard Class="pin-card animate-fadeIn">
                    <div class="pin-content">
                        <h3>@pin.Title</h3>
                        <p>@pin.TextContext</p>

                        @if (pin.FileData != null)
                        {
                            <img src="data:image/png;base64,@pin.FileData" class="pin-image" />
                        }
                    </div>

                    <div class="pin-actions">
                        <MatIconButton Icon="delete_forever"
                                       OnClick="@(() => RemovePin(pin))"
                                       Color="MatThemeColor.Secondary"
                                       Title="Delete pin" />
                    </div>
                </MatCard>
            }
        }
    </div>
</div>

@code {
    private bool _isPinFormVisible;
    private string _errorMessage = string.Empty;

    private PinItemDto _currentPin = new();
    private List<PinItem> _pinList = new();

    public void TogglePinVisibility() => _isPinFormVisible = !_isPinFormVisible;

    async Task FilesReady(IMatFileUploadEntry[] files)
    {
        try
        {
            var file = files.FirstOrDefault();
            if (file == null) return;

            using var stream = new MemoryStream();
            await file.WriteToStreamAsync(stream);
            _currentPin.FileData = Convert.ToBase64String(stream.ToArray());
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void AddPin()
    {
        try
        {
            var createPin = new PinItem(_currentPin.Title, _currentPin.TextContext, _currentPin.FileData);
            PinService.AddPin(createPin);
            _pinList = PinService.GetPins();
            _currentPin = new();
            _isPinFormVisible = false;
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
    }

    private void RemovePin(PinItem pin)
    {
        PinService.RemovePin(pin);
        _pinList = PinService.GetPins();
    }

    protected override Task OnInitializedAsync()
    {
        _pinList = PinService.GetPins();
        return Task.CompletedTask;
    }
}
