@page "/pinboard"
@using MEOW.Components.Models
@inject Services.PinService PinService

<link href="../wwwroot/css/pinboard.css" rel="stylesheet" />
<button @onclick="TogglePinVisibility">@(_isPinFormVisible ? "Hide pin module" : "Add pin")</button>

@if (_isPinFormVisible)
{
    <EditForm Model="@_currentPin" OnValidSubmit="AddPinAsync">
        <DataAnnotationsValidator/>

        <InputText @bind-Value="_currentPin.Title" placeholder="Title..." />
        <ValidationMessage For="@(() => _currentPin.Title)" />

        <br/>
        <textarea cols="15" rows="5" @bind="_currentPin.TextContext" placeholder="Insert context here..."></textarea>
        <ValidationMessage For="@(() => _currentPin.TextContext)" />

        <br/>
        <InputFile OnChange="OnFileSelected"/>
        @if (!string.IsNullOrEmpty(_currentPin.FileDataUrl))
        {
            <img src="@_currentPin.FileDataUrl" alt="Preview" style="max-width:100px;"/>
        }
        
        <br/>
        <button type="submit">Create pin</button>
    </EditForm>
}

@if (_isFileLoading && _selectedFile != null)
{
    <ul>
        <li>Name: @_selectedFile.Name</li>
        <li>Last modified: @_selectedFile.LastModified.ToString()</li>
        <li>Size (bytes): @_selectedFile.Size</li>
        <li>Content type: @_selectedFile.ContentType</li>
    </ul>
}

@if (!_pinList.Any())
{
    <p>No pins created.</p>
}
else
{
    <div class="scrollable">
        <ul>
            @foreach (var pin in _pinList)
            {
                <li>
                    <strong>@pin.Title</strong><br/>
                    @pin.TextContext<br/>
                    @if (!string.IsNullOrEmpty(pin.FileDataUrl))
                    {
                        <img src="@pin.FileDataUrl" alt="image" style="max-width:100px;" />
                    }
                    <button type="button" @onclick="() => RemovePinAsync(pin)">x</button>
                </li>
            }
        </ul>
    </div>
}

@code {
    private bool _isPinFormVisible;
    private bool _isFileLoading;
    private IBrowserFile? _selectedFile;

    private PinItem _currentPin = new();
    private List<PinItem> _pinList = new();

    private void TogglePinVisibility() => _isPinFormVisible = !_isPinFormVisible;

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _currentPin.File = e.File;
        _isFileLoading = true;

        try
        {
            await using var stream = _selectedFile.OpenReadStream();
            var buffer = new byte[_selectedFile.Size];
            await stream.ReadAsync(buffer);
            _currentPin.FileDataUrl = $"data:{_selectedFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"File load error: {ex.Message}");
        }
        finally
        {
            _isFileLoading = false;
        }
    }

    private async Task AddPinAsync()
    {    
        PinService.AddPin(_currentPin);
        _pinList = await PinService.GetPins();

        ResetForm();
    }

    private async Task RemovePinAsync(PinItem pin)
    {
        PinService.RemovePin(pin);
        _pinList = await PinService.GetPins();
    }

    private void ResetForm()
    {
        _currentPin = new PinItem();
        _selectedFile = null;
        _isFileLoading = false;
    }

    protected override async Task OnInitializedAsync()
    {
        _pinList = await PinService.GetPins();
    }
}
