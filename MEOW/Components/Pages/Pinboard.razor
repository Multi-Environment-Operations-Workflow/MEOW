@page "/Pinboard"
@using System.Diagnostics
@using MEOW.Components.DTO_s
@using MEOW_BUSINESS.Models
@using MEOW_BUSINESS.Services
@using System.Collections.Specialized
@inject IPinService PinService

<div class="pinboard-container">
    <div class="pinboard-header">
        <h2 class="pinboard-title">Pinboard</h2>

        <MatButton Raised="true" Icon="@(_isPinFormVisible ? "expand_less" : "add_circle_outline")"
            OnClick="TogglePinVisibility" Class="add-pin-btn">
            @(_isPinFormVisible ? "Hide Form" : "Add Pin")
        </MatButton>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-banner">
            <MatIcon>error</MatIcon>
            <span>@_errorMessage</span>
        </div>
    }

    @if (_isPinFormVisible)
    {
        <div class="pin-form-card">
            <EditForm Model="@_currentPin" OnValidSubmit="AddPin">
                <DataAnnotationsValidator />

                <div class="form-section">
                    <MatTextField Label="Title" @bind-Value="_currentPin.Title" Required="true" FullWidth="true"
                        Class="custom-mat-field" Placeholder="Enter a catchy title..." />
                    <ValidationMessage For="@(() => _currentPin.Title)" class="validation-message" />
                </div>

                <div class="form-section">
                    <MatTextField Label="Description" @bind-Value="_currentPin.TextContext" TextArea="true" Rows="7"
                        FullWidth="true" Class="custom-mat-textarea"
                        Placeholder="Add some context or details about this pin..." />
                    <ValidationMessage For="@(() => _currentPin.TextContext)" class="validation-message" />
                </div>

                <div class="upload-section">
                    <MatIcon Class="upload-icon">cloud_upload</MatIcon>
                    <div class="upload-label">
                        <MatFileUpload OnChange="@FilesReady" Label="Drop an image here or click to browse"
                            Accept="image/*" />
                    </div>
                </div>

                @if (_currentPin.FileData != null)
                {
                    <div class="preview-image">
                        <img src="data:image/png;base64,@_currentPin.FileData" alt="Preview" />
                    </div>
                }

                <div class="form-actions">
                    <MatButton Raised="true" Icon="add_task" Type="submit" Class="create-pin-btn">
                        Create Pin
                    </MatButton>
                </div>
            </EditForm>
        </div>
    }

    <div class="pins-list">
        @if (!_pinList.Any())
        {
            <div class="empty-state">
                <MatIcon>push_pin</MatIcon>
                <p>No pins yet â€” click "Add Pin" to get started!</p>
            </div>
        }
        else
        {
            @foreach (var pin in _pinList)
            {
                <div class="pin-card">
                    <div class="pin-content">
                        <h3>@pin.Title</h3>

                        @if (!string.IsNullOrEmpty(pin.TextContext))
                        {
                            <p>@pin.TextContext</p>
                        }

                        @if (pin.FileData != null)
                        {
                            <img src="data:image/png;base64,@pin.FileData" alt="@pin.Title" class="pin-image" />
                        }
                    </div>

                    <div class="pin-actions">
                        <MatButton Outlined="true" Icon="delete_forever" OnClick="@(() => RemovePin(pin))" Class="delete-btn">
                            Delete
                        </MatButton>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private bool _isPinFormVisible;
    private string _errorMessage = string.Empty;

    private PinItemDto _currentPin = new();
    private List<PinItem> _pinList = new();

    public void TogglePinVisibility() => _isPinFormVisible = !_isPinFormVisible;


    async Task FilesReady(IMatFileUploadEntry[] files)
    {
        try
        {
            var file = files.FirstOrDefault();
            if (file == null)
            {
                return;
            }

            var stream = new MemoryStream();
            var sw = Stopwatch.StartNew();
            await file.WriteToStreamAsync(stream);
            sw.Stop();
            _currentPin.FileData = Convert.ToBase64String(stream.ToArray());
        }
        catch (Exception e)
        {
            _errorMessage = $"Error:\r\n{e.Message}\r\n{e.StackTrace}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void AddPin()
    {
        try
        {
            var createPin = new PinItem(_currentPin.Title, _currentPin.TextContext, _currentPin.FileData);
            PinService.AddPin(createPin);
            _pinList = PinService.GetPins();
            ResetForm();
        }
        catch (Exception e)
        {
            _errorMessage = $"Error:\r\n{e.Message}\r\n{e.StackTrace}";
        }
    }

    private void RemovePin(PinItem pin)
    {
        PinService.RemovePin(pin);
        _pinList = PinService.GetPins();
    }

    private void ResetForm()
    {
        _currentPin = new PinItemDto();
    }

    private void onNewMessage(object? _, NotifyCollectionChangedEventArgs e)
    {
        try
        {
            if (e.Action != NotifyCollectionChangedAction.Add || e.NewItems == null) return;
            _pinList.AddRange(e.NewItems.Cast<PinItem>());
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {

        }
    }

    protected override Task OnInitializedAsync()
    {
        _pinList = PinService.GetPins();
        PinService.SetupPinReceivedAction(onNewMessage);
        return base.OnInitializedAsync();
    }
}
