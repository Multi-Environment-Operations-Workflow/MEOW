@page "/pinboard"
@using MEOW.Components.Models
@inject Services.PinService PinService

<link href="wwwroot/css/Pinboard.razor.css" rel="stylesheet" />

<MatCard Class="p-6 m-4">

    <MatButton Raised="true" OnClick="TogglePinVisibility" Icon="add_circle_outline">
        @(_isPinFormVisible ? "Hide Pin Module" : "Add Pin")
    </MatButton>

    @if (_isPinFormVisible)
    {
        <MatCard Class="mt-4 p-4">

            <EditForm Model="@_currentPin" OnValidSubmit="AddPinAsync">
                <DataAnnotationsValidator />

                <MatTextField Label="Title"
                              @bind-Value="_currentPin.Title"
                              Required="true"
                              FullWidth="true"
                              Class="mb-4" />
                <ValidationMessage For="@(() => _currentPin.Title)" />

                <MatTextField Label="Context"
                              @bind-Value="_currentPin.TextContext"
                              TextArea="true"
                              Rows="5"
                              FullWidth="true"
                              Class="mb-4" />
                <ValidationMessage For="@(() => _currentPin.TextContext)" />

                <MatDivider Class="my-3" />

                <MatFileUpload OnChange="@FilesReady"
                               Label="Drop a file or browse"
                               Icon="cloud_upload"
                               Accept="image/*" />

                @if (list.Any())
                {
                    <MatList Class="mt-2">
                        @foreach (var f in list)
                        {
                            <MatListItem>@f</MatListItem>
                        }
                    </MatList>
                }

                @if (!string.IsNullOrEmpty(_currentPin.FileDataUrl))
                {
                    <div class="mt-3 flex justify-center">
                        <img src="@_currentPin.FileDataUrl"
                             alt="Preview"
                             style="max-width:150px;border-radius:8px;" />
                    </div>
                }

                <MatDivider Class="my-4" />

                <MatButton Raised="true" Icon="add_task" Type="submit" Color="MatThemeColor.Primary">
                    Create Pin
                </MatButton>
            </EditForm>
        </MatCard>
    }

    <MatDivider Class="my-6" />

    @if (!_pinList.Any())
    {
        <MatCard Class="p-4 text-center text-gray-500">
            <MatIcon>info</MatIcon> No pins created yet.
        </MatCard>
    }
    else
    {
        <div class="grid gap-4">
            @foreach (var pin in _pinList)
            {
                <MatCard Class="p-4 flex justify-between items-start">
                    <div class="flex-1 pr-4">
                        <h3 class="font-semibold text-lg mb-1">@pin.Title</h3>
                        <p class="text-sm text-gray-700 mb-2">@pin.TextContext</p>

                        @if (!string.IsNullOrEmpty(pin.FileDataUrl))
                        {
                            <img src="@pin.FileDataUrl"
                                 alt="image"
                                 style="max-width:120px;border-radius:8px;" />
                        }
                    </div>

                    <div class="flex items-start">
                        <MatIconButton Icon="delete_forever"
                                       OnClick="@(() => RemovePinAsync(pin))"
                                       Color="MatThemeColor.Secondary"
                                       Title="Delete pin" />
                    </div>
                </MatCard>
            }
        </div>
    }

</MatCard>

@code {
    private bool _isPinFormVisible;
    private IBrowserFile? _selectedFile;

    private PinItem _currentPin = new("", "");
    private List<PinItem> _pinList = new();
    private List<string> list = new();

    private void TogglePinVisibility() => _isPinFormVisible = !_isPinFormVisible;

    private void FilesReady(IMatFileUploadEntry[] files)
    {
        list.Clear();
        foreach (var file in files)
        {
            list.Add($"Name: {file.Name} - Size: {file.Size}");
        }
    }

    private async Task AddPinAsync()
    {
        PinItem createPin = new (_currentPin.Title, _currentPin.TextContext);
        PinService.AddPin(createPin);
        _pinList = await PinService.GetPins();
        ResetForm();
    }

    private async Task RemovePinAsync(PinItem pin)
    {
        PinService.RemovePin(pin);
        _pinList = await PinService.GetPins();
    }

    private void ResetForm()
    {
        _currentPin.Title = "";
        _currentPin.TextContext = "";
        _selectedFile = null;
        list.Clear();
    }

    protected override async Task OnInitializedAsync()
    {
        _pinList = await PinService.GetPins();
    }
}
