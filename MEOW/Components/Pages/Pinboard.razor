@page "/Pinboard"
@using System.Diagnostics
@using MEOW.Components.DTO_s
@using MEOW.Components.Models
@using MEOW.Components.Services
@using System.Collections.Specialized
@inject IPinService PinService

<div class="pinboard-container">
    <div class="pinboard-header">
        <h2 class="pinboard-title">Pinboard</h2>

        <MatButton Raised="true" 
                   Icon="@(_isPinFormVisible ? "expand_less" : "add_circle_outline")" 
                   OnClick="TogglePinVisibility"
                   Class="add-pin-btn">
            @(_isPinFormVisible ? "Hide Form" : "Add Pin")
        </MatButton>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-banner">
            <MatIcon>error</MatIcon>
            <span>@_errorMessage</span>
        </div>
    }

    @if (_isPinFormVisible)
    {
        <div class="pin-form-card animate-fadeIn">
            <EditForm Model="@_currentPin" OnValidSubmit="AddPin">
                <DataAnnotationsValidator />

                <div class="form-section">
                    <label class="form-label">Title *</label>
                    <MatTextField @bind-Value="_currentPin.Title" 
                               placeholder="Enter a catchy title..." />
                    <ValidationMessage For="@(() => _currentPin.Title)" class="validation-message" />
                </div>

                <div class="form-section">
                    <label class="form-label">Description</label>
                    <MatTextField @bind-Value="_currentPin.TextContext"
                                   placeholder="Add details about this pin..." />
                    <ValidationMessage For="@(() => _currentPin.TextContext)" class="validation-message" />
                </div>

                <div class="upload-section">
                    <MatIcon Class="upload-icon">cloud_upload</MatIcon>
                    <div class="upload-label">
                        <MatFileUpload OnChange="@FilesReady"
                                       Label="Drop an image here or click to browse"
                                       Accept="image/*" />
                    </div>
                </div>

                @if (_currentPin.FileData != null)
                {
                    <div class="preview-image animate-fadeIn">
                        <img src="data:image/png;base64,@_currentPin.FileData" alt="Preview" />
                    </div>
                }

                <div class="form-actions">
                    <MatButton Raised="true" 
                               Icon="add_task" 
                               Type="submit" 
                               Class="create-pin-btn">
                        Create Pin
                    </MatButton>
                </div>
            </EditForm>
        </div>
    }

    <div class="pins-list">
        @if (!_pinList.Any())
        {
            <div class="empty-state animate-fadeIn">
                <MatIcon>push_pin</MatIcon>
                <p>No pins yet â€” click "Add Pin" to get started!</p>
            </div>
        }
        else
        {
            @foreach (var pin in _pinList)
            {
                <div class="pin-card animate-fadeIn">
                    <div class="pin-content">
                        <h3>@pin.Title</h3>
                        
                        @if (!string.IsNullOrEmpty(pin.TextContext))
                        {
                            <p>@pin.TextContext</p>
                        }

                        @if (pin.FileData != null)
                        {
                            <img src="data:image/png;base64,@pin.FileData" 
                                 alt="@pin.Title" 
                                 class="pin-image" />
                        }
                    </div>

                    <div class="pin-actions">
                        <MatButton Outlined="true"
                                   Icon="delete_forever"
                                   OnClick="@(() => RemovePin(pin))"
                                   Class="delete-btn">
                            Delete
                        </MatButton>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private bool _isPinFormVisible;
    private string _errorMessage = string.Empty;

    private PinItemDto _currentPin = new();
    private List<PinItem> _pinList = new();

    public void TogglePinVisibility() => _isPinFormVisible = !_isPinFormVisible;


    async Task FilesReady(IMatFileUploadEntry[] files)
    {
        try
        {
            _errorMessage = string.Empty;
            var file = files.FirstOrDefault();
            if (file == null) return;

            using var stream = new MemoryStream();
            await file.WriteToStreamAsync(stream);
            _currentPin.FileData = Convert.ToBase64String(stream.ToArray());
        }
        catch (Exception e)
        {
            _errorMessage = $"Failed to upload image: {e.Message}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void AddPin()
    {
        try
        {
            _errorMessage = string.Empty;
            var createPin = new PinItem(_currentPin.Title, _currentPin.TextContext, _currentPin.FileData);
            PinService.AddPin(createPin);
            _pinList = PinService.GetPins();
            _currentPin = new();
            _isPinFormVisible = false;
        }
        catch (Exception e)
        {
            _errorMessage = $"Failed to create pin: {e.Message}";
        }
    }

    private void RemovePin(PinItem pin)
    {
        try
        {
            _errorMessage = string.Empty;
            PinService.RemovePin(pin);
            _pinList = PinService.GetPins();
        }
        catch (Exception e)
        {
            _errorMessage = $"Failed to delete pin: {e.Message}";
        }
    }

    private void onNewMessage(object? _, NotifyCollectionChangedEventArgs e)
    {
        try
        {
            if (e.Action != NotifyCollectionChangedAction.Add || e.NewItems == null) return;
            _pinList.AddRange(e.NewItems.Cast<PinItem>());
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
    
        }
    }

    protected override Task OnInitializedAsync()
    {
        _pinList = PinService.GetPins();
        PinService.SetupPinReceivedAction(onNewMessage);
        return base.OnInitializedAsync();
    }
}