@page "/Pinboard"
@using System.Diagnostics
@using MEOW.Components.DTO_s
@using MEOW.Components.Models
@inject Services.PinService PinService

<MatCard Class="p-6 m-4">
    
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MatCard Class="mb-4 p-4 bg-red-100 text-red-800">
            <MatIcon>error</MatIcon>
            <span class="ml-2">@_errorMessage</span>
        </MatCard>
    }

    <MatButton Raised="true" OnClick="TogglePinVisibility" Icon="add_circle_outline">
        @(_isPinFormVisible ? "Hide Pin Module" : "Add Pin")
    </MatButton>

    @if (_isPinFormVisible)
    {
        <MatCard Class="mt-4 p-4">

            <EditForm Model="@_currentPin" OnValidSubmit="AddPin">
                <DataAnnotationsValidator/>

                <MatTextField Label="Title"
                              @bind-Value="_currentPin.Title"
                              Required="true"
                              FullWidth="true"
                              Class="mb-4"/>
                <ValidationMessage For="@(() => _currentPin.Title)"/>

                <MatTextField Label="Context"
                              @bind-Value="_currentPin.TextContext"
                              TextArea="true"
                              Rows="5"
                              FullWidth="true"
                              Class="mb-4"/>
                <ValidationMessage For="@(() => _currentPin.TextContext)"/>

                <MatDivider Class="my-3"/>

                <MatFileUpload OnChange="@FilesReady"
                               Label="Drop a file or browse"
                               Icon="cloud_upload"
                               Accept="image/*"/>

                @if (_currentPin.FileData != null)
                {
                    <div class="mt-3 flex justify-center">
                        <img src="data:image/png;base64,@_currentPin.FileData" style="max-width:150px;border-radius:8px;"/>
                    </div>
                }

                <MatDivider Class="my-4"/>

                <MatButton Raised="true" Icon="add_task" Type="submit" Color="MatThemeColor.Primary">
                    Create Pin
                </MatButton>
            </EditForm>
        </MatCard>
    }

    <MatDivider Class="my-6"/>

    @if (!_pinList.Any())
    {
        <MatCard Class="p-4 text-center text-gray-500">
            <MatIcon>info</MatIcon> No pins created yet.
        </MatCard>
    }
    else
    {
        <div class="grid gap-4">
            @foreach (var pin in _pinList)
            {
                <MatCard Class="p-4 flex justify-between items-start">
                    <div class="flex-1 pr-4">
                        <h3 class="font-semibold text-lg mb-1">@pin.Title</h3>
                        <p class="text-sm text-gray-700 mb-2">@pin.TextContext</p>

                        @if (pin.FileData != null)
                        {
                            <img src="data:image/png;base64,@pin.FileData" style="max-width:120px;border-radius:8px;"/>
                        }
                    </div>

                    <div class="flex items-start">
                        <MatIconButton Icon="delete_forever"
                                       OnClick="@(() => RemovePin(pin))"
                                       Color="MatThemeColor.Secondary"
                                       Title="Delete pin"/>
                    </div>
                </MatCard>
            }
        </div>
    }

</MatCard>

@code {
    private bool _isPinFormVisible;
    private string _errorMessage = string.Empty;

    private PinItemDto _currentPin = new();
    private List<PinItem> _pinList = new();

    public void TogglePinVisibility() => _isPinFormVisible = !_isPinFormVisible;

    
    async Task FilesReady(IMatFileUploadEntry[] files)
    {
        try
        {
            var file = files.FirstOrDefault();
            if (file == null)
            {
                return;
            }

            var stream = new MemoryStream();
            var sw = Stopwatch.StartNew();
            await file.WriteToStreamAsync(stream);
            sw.Stop();
            _currentPin.FileData = Convert.ToBase64String(stream.ToArray());
        }
        catch (Exception e)
        {
            _errorMessage = $"Error:\r\n{e.Message}\r\n{e.StackTrace}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void AddPin()
    {
        try
        {
            var createPin = new PinItem(_currentPin.Title, _currentPin.TextContext, _currentPin.FileData);
            PinService.AddPin(createPin);
            _pinList = PinService.GetPins();
            ResetForm();
        }
        catch (Exception e)
        {
            _errorMessage = $"Error:\r\n{e.Message}\r\n{e.StackTrace}";
        }
    }

    private void RemovePin(PinItem pin)
    {
        PinService.RemovePin(pin);
        _pinList = PinService.GetPins();
    }

    private void ResetForm()
    {
        _currentPin = new PinItemDto();
    }

    protected override Task OnInitializedAsync()
    {
        _pinList = PinService.GetPins();
        return base.OnInitializedAsync();
    }
}
